<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>2.6.1 Upgrading Plugins 1.0.0.BUILD-SNAPSHOT</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Upgrading Grails Applications
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/versions.html"><strong>1</strong><span>Comparing Versions</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/upgrading.html"><strong>2</strong><span>Upgrading</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/versions.html">&lt;&lt; <strong>1</strong><span>Comparing Versions</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                


                <div class="project">
                    <h1>2.6.1 Upgrading Plugins</h1>

                    <p><strong>Version:</strong> 1.0.0.BUILD-SNAPSHOT</p>
                </div>

                

                

<h2 id="upgradingPlugins">2.6.1 Upgrading Plugins</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails/grails-upgrade/edit/master/src/main/docs/guide/upgrading/upgrading2x/upgradingPlugins.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To upgrade a Grails 2.x plugin to Grails 3.x you need to make a number of different changes. This documentation will outline the steps that were taken to upgrade the Quartz plugin to Grails 3, each individual plugin may differ.</p>
</div>
<div class="sect3">
<h4 id="_step_1_create_a_new_grails_3_plugin">Step 1 - Create a new Grails 3 plugin</h4>
<div class="paragraph">
<p>The first step is to create a new Grails 3 plugin using the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ grails create-plugin quartz</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will create a Grails 3 plugin in the <code>quartz</code> directory.</p>
</div>
</div>
<div class="sect3">
<h4 id="_step_2_copy_sources_from_the_original_grails_2_plugin">Step 2 - Copy sources from the original Grails 2 plugin</h4>
<div class="paragraph">
<p>The next step is to copy the sources from the original Grails 2 plugin to the Grails 3 plugin:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># first the sources
cp -rf ../quartz-2.x/src/groovy/ src/main/groovy
cp -rf ../quartz-2.x/src/java/ src/main/groovy
cp -rf ../quartz-2.x/grails-app/ grails-app
cp -rf ../quartz-2.x/QuartzGrailsPlugin.groovy src/main/groovy/grails/plugins/quartz

# then the tests
cp -rf ../quartz-2.x/test/unit/* src/test/groovy
mkdir -p src/integration-test/groovy
cp -rf ../quartz-2.x/test/integration/* src/integration-test/groovy

# then templates / other resources
cp -rf ../quartz-2.x/src/templates/ src/main/templates</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_step_3_alter_the_plugin_descriptor">Step 3 - Alter the plugin descriptor</h4>
<div class="paragraph">
<p>You will need to add a package declaration to the plugin descriptor. In this case <code>QuartzGrailsPlugin</code> is modified as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="comment">// add package declaration</span>
<span class="keyword">package</span> grails.plugins.quartz
...
class QuartzGrailsPlugin <span class="directive">extends</span> Plugin {
 ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition you should remove the <code>version</code> property from the descriptor as this is now defined in <code>build.gradle</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_step_4_update_the_gradle_build_with_required_dependencies">Step 4 - Update the Gradle build with required dependencies</h4>
<div class="paragraph">
<p>The repositories and dependencies defined in <code>grails-app/conf/BuildConfig.groovy</code> of the original Grails 2.x plugin will need to be defined in <code>build.gradle</code> of the new Grails 3.x plugin:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">compile(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.quartz-scheduler:quartz:2.2.1</span><span class="delimiter">&quot;</span></span>) {
    exclude <span class="key">group</span>: <span class="string"><span class="delimiter">'</span><span class="content">slf4j-api</span><span class="delimiter">'</span></span>, <span class="key">module</span>: <span class="string"><span class="delimiter">'</span><span class="content">c3p0</span><span class="delimiter">'</span></span>
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is recommended to use the latest stable, Grails 3+ compatible version of plugins. (Grails 2.x plugin versions will not work.)</p>
</div>
</div>
<div class="sect3">
<h4 id="_step_5_modify_package_imports">Step 5 - Modify Package Imports</h4>
<div class="paragraph">
<p>In Grails 3.x all internal APIs can be found in the <code>org.grails</code> package and public facing APIs in the <code>grails</code> package. The <code>org.codehaus.groovy.grails</code> package no longer exists.</p>
</div>
<div class="paragraph">
<p>All package declaration in sources should be modified for the new location of the respective classes. Example <code>org.codehaus.groovy.grails.commons.GrailsApplication</code> is now <code>grails.core.GrailsApplication</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_step_5_migrate_plugin_specific_config_to_application_yml">Step 5 - Migrate Plugin Specific Config to application.yml</h4>
<div class="paragraph">
<p>Some plugins define a default configuration file. For example the Quartz plugin defines a file called <code>grails-app/conf/DefaultQuartzConfig.groovy</code>. In Grails 3.x this default configuration can be migrated to <code>grails-app/conf/application.yml</code> and it will automatically be loaded by Grails without requiring manual configuration merging.</p>
</div>
</div>
<div class="sect3">
<h4 id="_step_6_update_plugin_exclusions">Step 6 - Update plugin exclusions</h4>
<div class="paragraph">
<p>Old plugins may have a <code>pluginExcludes</code> property defined that lists the patterns for any files that should not be included in the plugin package. This is normally used to exclude artifacts such as domain classes that are used in the plugin&#8217;s integration tests. You generally don&#8217;t want these polluting the target application.</p>
</div>
<div class="paragraph">
<p>This property is no longer sufficient in Grails 3, and nor can you use source paths. Instead, you must specify patterns that match the paths of the compiled classes. For example, imagine you have some test domain classes in the <code>grails-app/domain/plugin/tests</code> directory. You should first change the <code>pluginExcludes</code> value to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> pluginExcludes = [<span class="string"><span class="delimiter">&quot;</span><span class="content">plugin/test/**</span><span class="delimiter">&quot;</span></span>]</code></pre>
</div>
</div>
<div class="paragraph">
<p>and then add this block to the build file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">jar {
    exclude <span class="string"><span class="delimiter">&quot;</span><span class="content">plugin/test/**</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The easiest way to ensure these patterns work effectively is to put all your non-packaged class into a distinct Java package so that there is a clean separation between the main plugin classes and the rest.</p>
</div>
</div>
<div class="sect3">
<h4 id="_step_7_register_artefacthandler_definitions">Step 7 - Register ArtefactHandler Definitions</h4>
<div class="paragraph">
<p>In Grails 3.x <a href="http://docs.grails.org/1.0.0.BUILD-SNAPSHOT/api/grails/core/ArtefactHandler.html">ArtefactHandler</a> definitions written in Java need to be declared in a file called <code>src/main/resources/META-INF/grails.factories</code> since these need to be known at compile time.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the <code>ArtefactHandler</code> is written in Groovy this step can be skipped as Grails will automatically create the <code>grails.factories</code> file during compilation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Quartz plugin requires the following definition to register the <code>ArtrefactHandler</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">grails.core.ArtefactHandler=grails.plugins.quartz.JobArtefactHandler</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_step_8_migrate_code_generation_scripts">Step 8 - Migrate Code Generation Scripts</h4>
<div class="paragraph">
<p>Many plugins previously defined command line scripts in Gant. In Grails 3.x command line scripts have been replaced by two new features: Code generation scripts and Gradle tasks.</p>
</div>
<div class="paragraph">
<p>If your script is doing simple code generation then for many cases a code generation script can replace an old Gant script.</p>
</div>
<div class="paragraph">
<p>The <code>create-job</code> script provided by the Quartz plugin in Grails 2.x was defined in <code>scripts/CreateJob.groovy</code> as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">includeTargets &lt;&lt; grailsScript(<span class="string"><span class="delimiter">&quot;</span><span class="content">_GrailsCreateArtifacts</span><span class="delimiter">&quot;</span></span>)

target(<span class="key">createJob</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Creates a new Quartz scheduled job</span><span class="delimiter">&quot;</span></span>) {
    depends(checkVersion, parseArguments)

    <span class="keyword">def</span> type = <span class="string"><span class="delimiter">&quot;</span><span class="content">Job</span><span class="delimiter">&quot;</span></span>
    promptForName(<span class="key">type</span>: type)

    <span class="keyword">for</span> (name <span class="keyword">in</span> argsMap.params) {
        name = purgeRedundantArtifactSuffix(name, type)
        createArtifact(<span class="key">name</span>: name, <span class="key">suffix</span>: type, <span class="key">type</span>: type, <span class="key">path</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">grails-app/jobs</span><span class="delimiter">&quot;</span></span>)
        createUnitTest(<span class="key">name</span>: name, <span class="key">suffix</span>: type)
    }
}

setDefaultTarget <span class="string"><span class="delimiter">'</span><span class="content">createJob</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A replacement Grails 3.x compatible script can be created using the <code>create-script</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ grails create-script create-job</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which creates a new script called <code>src/main/scripts/create-job.groovy</code>. Using the new code generation API it is simple to implement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">description(<span class="string"><span class="delimiter">&quot;</span><span class="content">Creates a new Quartz scheduled job</span><span class="delimiter">&quot;</span></span>) {
    usage <span class="string"><span class="delimiter">&quot;</span><span class="content">grails create-job &lt;&lt;JOB NAME&gt;&gt;</span><span class="delimiter">&quot;</span></span>
    argument <span class="key">name</span>:<span class="string"><span class="delimiter">'</span><span class="content">Job Name</span><span class="delimiter">'</span></span>, <span class="key">description</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">The name of the job</span><span class="delimiter">&quot;</span></span>
}

model = model( args[<span class="integer">0</span>] )
render  <span class="key">template</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Job.groovy</span><span class="delimiter">&quot;</span></span>,
        <span class="key">destination</span>: file( <span class="string"><span class="delimiter">&quot;</span><span class="content">grails-app/jobs/</span><span class="inline"><span class="inline-delimiter">$</span>model</span><span class="content">.packagePath/</span><span class="inline"><span class="inline-delimiter">${</span>model.simpleName<span class="inline-delimiter">}</span></span><span class="content">Job.groovy</span><span class="delimiter">&quot;</span></span>),
        <span class="key">model</span>: model</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please refer to the documentation on <a href="commandLine.html#creatingCustomScripts">Creating Custom Scripts</a> for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="_migrating_more_complex_scripts_using_gradle_tasks">Migrating More Complex Scripts Using Gradle Tasks</h4>
<div class="paragraph">
<p>Using the old Grails 2.x build system it was relatively common to spin up Grails inside the command line. In Grails 3.x it is not possible to load a Grails application within a code generation script created by the <a href="../ref/Command%20Line/create-script.html">create-script</a> command.</p>
</div>
<div class="paragraph">
<p>Instead a new mechanism specific to plugins exists via the <a href="../ref/Command%20Line/create-command.html">create-command</a> command. The <code>create-command</code> command will create a new <a href="http://docs.grails.org/1.0.0.BUILD-SNAPSHOT/api/grails/dev/commands/ApplicationCommand.html">ApplicationCommand</a>, for example the following command will execute a query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.dev.commands.*</span>
<span class="keyword">import</span> <span class="include">javax.sql.*</span>
<span class="keyword">import</span> <span class="include">groovy.sql.*</span>
<span class="keyword">import</span> <span class="include">org.springframework.beans.factory.annotation.*</span>

<span class="type">class</span> <span class="class">RunQueryCommand</span> <span class="directive">implements</span> ApplicationCommand {

  <span class="annotation">@Autowired</span>
  <span class="predefined-type">DataSource</span> dataSource

  <span class="type">boolean</span> handle(ExecutionContext ctx) {
      <span class="keyword">def</span> sql = <span class="keyword">new</span> Sql(dataSource)
      println sql.executeQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">select * from foo</span><span class="delimiter">&quot;</span></span>)
      <span class="keyword">return</span> <span class="predefined-constant">true</span>
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this command in place once the plugin is installed into your local Maven cache you can add the plugin to both the build classpath and the runtime classpath of the application&#8217;s <code>build.gradle</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">buildscript {
  ...
  dependencies {
    classpath <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails.plugins:myplugin:0.1-SNAPSHOT</span><span class="delimiter">&quot;</span></span>
  }
}
...
dependencies {
  runtime <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails.plugins:myplugin:0.1-SNAPSHOT</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Grails will automatically create a Gradle task called <code>runQuery</code> and a command named <code>run-query</code> so both the following examples will execute the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ grails run-query
$ gradle runQuery</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_step_8_delete_files_that_were_migrated_or_no_longer_used">Step 8 - Delete Files that were migrated or no longer used</h4>
<div class="paragraph">
<p>You should now delete and cleanup the project of any files no longer required by Grails 3.x (<code>BuildConfig.groovy</code>, <code>Config.groovy</code>, <code>DataSource.groovy</code> etc.)</p>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/versions.html">&lt;&lt; <strong>1</strong><span>Comparing Versions</span></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
